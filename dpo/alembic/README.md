# Alembic

## Usage

### To upgrade to the latest schema

```bash
alembic -c dpo/alembic.ini -x $DESTINATION_DB_URL upgrade head
```

### Updating the schema

Ensure any new tables inherit from the same Base used in `alembic/env.py`

```python
from dpo.Shared import BaseEntity
```

Whenever you make a schema change, run

```bash
pipenv install .
alembic -c dpo/alembic.ini -x $DESTINATION_DB_URL revision -m "$REVISION_MESSAGE" --autogenerate
```

check that the new version in `alembic/versions` is correct

### Downgrading the schema

Whenever you want to downgrade the schema

```bash
alembic -c dpo/alembic.ini -x $DESTINATION_DB_URL history # see the list of revision ids
alembic -c dpo/alembic.ini -x $DESTINATION_DB_URL current # see the current revision id
alembic -c dpo/alembic.ini -x $DESTINATION_DB_URL downgrade -1 # revert back one revision
alembic -c dpo/alembic.ini -x $DESTINATION_DB_URL downgrade $revision_id # revert back to a revision id, found using the history command
```

## Troubleshooting

### Inaccurate autogenerated revisions

Does your autogenerated revision not look right?

Try editing the function `use_schema` in `alembic/env.py`, this determines what alembic looks for in the database.

[Relevant Documentation](https://alembic.sqlalchemy.org/en/latest/api/runtime.html?highlight=include_schemas#alembic.runtime.environment.EnvironmentContext.configure.params.include_object)

### New models aren't showing up in upgrade section

Ensure all model classes inherit from the same Base that `alembic/env.py` imports, and that the following class
properties are set

```python
__tablename__ = 'your_mapped_table_name'
__table_args__ = {'schema': Constants.DATA_PIPELINE_EXECUTION_SCHEMA_NAME}
```

Also try importing the models into `alembic/env.py`, eg

```python
from dpo.entities import ModelChecksumEntity
from dpo.entities import DataPipelineExecutionEntity
```

### Alembic won't pick up my change

[Alembic only supports some changes](https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect)

Try adding raw sql in the `upgrade()` and `downgrade()` functions of your revision

```python
op.execute(RAW_SQL)
```
